# コメント最適化 コードレビュープロンプト

目的: コード中のコメントを最小限かつ高品質に保つ。意図コメント(Why)とドキュメントコメント(Doc)以外は不要とし、それらは削除または別の形(コード/テスト/命名/ADR)に置換する。

## レビューポリシー

- 許可するコメントは 3 種のみ
  1. 意図コメント: なぜこの実装/選択をしたか(背景・制約・トレードオフ・参照リンク・一時対応の撤去条件)
  2. Doc コメント: 公開 API/外部境界についての機械可読な仕様(JSDoc/TSdoc 等)
  3. ファイルコメント: ファイル全体の意図/前提/適用範囲/参照リンクを 1〜5 行で要約。履歴の羅列や自明な説明は不可。
- 上記以外(What/How の説明、明白な記述、ノイズ、進捗メモ)は不要。削除または別手段で表現。

## チェックリスト

- [ ] コメントは「Why(背景/制約/代替/根拠)」または「API 仕様」を述べているか
- [ ] コメントがコードの重複説明(What/How)になっていないか
- [ ] コメントで隠蔽された設計判断は ADR/Issue へ移譲し、1 行の意図コメント+リンクにできるか
- [ ] TODO/FIXME は期限・責任者・Issue リンクがあるか(なければ削除/作成)
- [ ] コメントアウトされたコードはないか(履歴管理へ。削除)
- [ ] 既に不正確/陳腐化したコメントはないか(更新 or 削除)
- [ ] Doc コメントが必要な公開 API に付いているか(パラメータ/戻り値/副作用/例外/前提条件)
- [ ] ファイル先頭コメントが必要なモジュールに存在し、最新か(背景/前提/制約/参照/撤去条件を簡潔に)
- [ ] 意図/Doc/ファイルコメントに参照リンク(ADR/Issue/Spec)があるか

## 禁止/削除対象(代表例)

- コードの逐語説明: // increment i, // sort array, // call API
- 自明な UI/DOM 説明、翻訳の繰り返し
- ログ代替/一時メモ、進捗メモ、長文の設計議論(→ ADR/Issue)
- コメントアウトされたコード、暫定フラグの記録
- TODO/FIXME に根拠やリンクがないもの

## 推奨の置換パターン

- What/How の説明 → 命名/分割/小関数化で読みやすくする
- 手続きの意図 → 1 行の意図コメント + Issue/ADR リンク
- 長文の背景 → ADR/Issue へ移し、コード側は短いリンクのみ
- コメントアウトコード → 削除(履歴は VCS)

## 意図コメントの要件(テンプレート)

- 含めるべき要素
  - 背景/制約(例: パフォーマンス SLO, 既知の API 制限, バグ番号)
  - 代替案とトレードオフ(一言)
  - 出典リンク(ADR/Issue/Spec)
  - 撤去条件(いつ消せるか)

例:

```ts
// Why: 上位の不具合 #12345 により X が不安定なため、暫定でリトライ上限を下げる。
// Alt: バックオフ導入は #67890 で検討中。Remove when #67890 merged.
const maxRetries = 2;
```

## ファイルコメントの要件(テンプレート)

- いつ書くか: モジュール/ファイルの役割や前提がコードだけでは伝わりにくい場合、外部制約が強い場合、暫定的な回避策を全体に適用している場合
- 含めるべき内容: 目的(Why)、前提/制約、適用範囲/非対象、参照(ADR/Issue/Spec)、撤去条件(いつ消せるか)

例:

```ts
/*
 * 目的: 決済API v1 の仕様制約に対応するアダプタ。
 * Why: 小数点以下2桁固定/通貨換算は外部で実施(#1234)。v2 移行までの暫定。
 * 前提/制約: 内部利用のみ。金額は最小通貨単位(センツ/銭)で受け取る。
 * 参照: ADR-007, Issue #5678, Spec https://example.com/spec
 * 撤去条件: v2 への完全移行後に削除。
 */
```

## Doc コメントの要件(公開 API)

- どこに書くか: ライブラリの公開関数/クラス/型、外部と合意するシリアライズ形式、複雑な前後条件のある API
- 含めるべき内容: 概要、パラメータ、戻り値、例外、副作用、前提/事後条件、使用例

TypeScript/JSDoc 例:

```ts
/**
 * キャッシュ付きでユーザープロファイルを取得します。
 * @param id - ユーザーID (UUID)
 * @param opts - オプション { ttlMs?: number }
 * @returns プロファイル。存在しない場合は NotFoundError を送出
 * @throws NotFoundError ユーザーが見つからない場合
 * @sideEffects メモリキャッシュの読み書きを行います
 * @example
 * const p = await getProfile(id, { ttlMs: 5000 });
 */
export async function getProfile(id: string, opts?: { ttlMs?: number }) {
  /* ... */
}
```

## 具体例: 不要コメントの除去

悪い:

```ts
// i を 1 増やす
let i = i + 1;
```

良い(命名で意図を表現):

```ts
retryCount += 1;
```

悪い:

```ts
// 一時的な回避策
// TODO: 後で修正する
doLegacyThing();
```

良い(意図+根拠+撤去条件):

```ts
// Why: API v2 のレート制限 (#321) を回避。v3 展開時に撤去(#654)。
doLegacyThing();
```

悪い:

```ts
// リストをアルファベット順に並べ替える
items.sort((a, b) => a.localeCompare(b));
```

良い(関数抽出):

```ts
const sortByLabel = (a: Item, b: Item) => a.label.localeCompare(b.label);
items.sort(sortByLabel);
```

## レビュー出力フォーマット(最小)

- Keep(意図/Doc): <場所> — 妥当性/更新提案(任意)
- Delete: <場所> — 理由(重複/自明/陳腐/ノイズ/コメントアウトコード など)
- Convert-To-Intent: <場所> — 推奨 1 行案 + 参照リンク
- Convert-To-Doc: <シンボル> — 必要項目の不足点
- Move-To-ADR/Issue: <トピック> — 要旨 + 推奨リンク先

## 重要度

- 🔴 Blocking: 誤解を招く/陳腐化したコメント、コメントアウトされたコード、根拠なき TODO、セキュリティ関連の誤説明
- 🟡 Should Fix: What/How 説明、長文コメント、リンク欠落の意図コメント
- 🟢 Nice to Have: Doc の例追加、表現の簡潔化

この方針: 「意図(Why)と Doc 以外は不要」。その他はコード/テスト/命名/設計ドキュメントで表現する。

# 単体テストルール

## 基本ルール

- **網羅テスト**：正常系・異常系・境界値のテストケースを作成する
- **振る舞いのテスト**：実装の詳細を確認するのではなく、その関数の振る舞いを確認するテストを作成する
- **モックの利用**：**基本はモックを使用しないこと**。実際のコンポーネントや関数を使用してテストする
- **モック許可対象**：外部依存（API 呼び出し、外部サービス、ファイルシステム、データベースなど）のみモックを使用可能
- **describe の利用**：describe を利用して、テストの可読性を意識すること
- **テストケース名**：日本語にすること
- **パラメータ化テスト**：it.each を活用して同じロジックの異なる入力値に対するテストを効率的に記述する
- **テスト量の適正化**：過度なテストは避け、重要な振る舞いに焦点を当てた効率的なテストを作成する

## モックルール詳細

### モックを使用しない対象

- 自作の関数・コンポーネント
- プロジェクト内のユーティリティ関数
- 内部状態管理ロジック
- UI コンポーネントの描画

### モックを使用できる対象

- HTTP リクエスト（fetch、axios など）
- 外部 API 呼び出し
- ファイルシステムアクセス
- データベース接続
- 外部サービス（認証プロバイダー、決済サービスなど）
- 時間に依存する処理（Date、setTimeout など）

## パラメータ化テスト・実行効率化

### it.each の活用

- 同じテストロジックで異なる入力値をテストする場合は `it.each` を使用する
- 可読性を保ちながらテストケースの重複を避ける
- テーブル形式でテストデータを整理する

```javascript
// 例：it.each を使用したパラメータ化テスト
describe("計算関数のテスト", () => {
  it.each([
    [1, 2, 3],
    [5, 5, 10],
    [-1, 1, 0],
    [0, 0, 0],
  ])("add(%i, %i) は %i を返す", (a, b, expected) => {
    expect(add(a, b)).toBe(expected);
  });

  // オブジェクト形式での記述も可能
  it.each([
    { input: "hello", expected: "HELLO" },
    { input: "world", expected: "WORLD" },
    { input: "", expected: "" },
  ])('toUpperCase("$input") は "$expected" を返す', ({ input, expected }) => {
    expect(toUpperCase(input)).toBe(expected);
  });
});
```

### 並行実行の活用

- Vitest の `concurrent` オプションを使用してテストを並行実行する
- 独立したテストケースは積極的に並行実行を行う
- ファイル単位でのパラレル実行も活用する

### 実行時間の最適化

- 重いテスト（統合テストなど）は最小限に抑える
- 単体テストを中心とした軽量なテスト構成にする
- テストデータの準備は効率的に行う

## テスト量の適正化

### 過度なテストを避ける指針

- **重複テストの排除**：同じ振る舞いを複数の方法でテストしない
- **実装詳細のテスト禁止**：private メソッドや内部状態の直接テストは行わない
- **価値のあるテストに集中**：ビジネスロジックや重要な振る舞いを優先する

### 適切なテスト範囲

- **公開インターフェースのみテスト**：外部から呼び出される関数・メソッドに集中
- **エッジケースの選択的テスト**：現実的に発生しうる境界値のみテストする
- **統合テストとのバランス**：単体テストで網羅しきれない部分は統合テストで補完

## テストピラミッド

### 基本概念

Google のテストピラミッドに基づき、適切なテストの配分を行う：

```
        /\
       /  \     E2E テスト (少)
      /    \    - ブラウザテスト
     /______\   - エンドツーエンドシナリオ
    /        \
   /          \  統合テスト (中)
  /            \ - コンポーネント間の連携
 /______________\- API との統合
/                \
\                / 単体テスト (多)
 \______________/  - 関数・メソッドレベル
                   - 個別コンポーネント
```

### 各レベルの役割と比率

#### 単体テスト (70-80%)

- **対象**: 個別の関数、メソッド、コンポーネント
- **特徴**: 高速、独立性、詳細なフィードバック
- **実装**: Jest/Vitest、React Testing Library
- **例**: ユーティリティ関数、カスタムフック、個別コンポーネント

#### 統合テスト (15-25%)

- **対象**: 複数のモジュール・コンポーネントの連携
- **特徴**: 実際の依存関係、中程度の実行速度
- **実装**: React Testing Library、MSW (Mock Service Worker)
- **例**: フォーム送信フロー、状態管理との連携

#### E2E テスト (5-10%)

- **対象**: ユーザーシナリオ全体
- **特徴**: 実際のブラウザ、低速、高い信頼性
- **実装**: Playwright、Cypress
- **例**: ログインからデータ表示までの完全なフロー

### 実装指針

- **Bottom-Up アプローチ**: 単体テストから始めて段階的に統合テストへ
- **重複の回避**: 下位レベルでテスト済みの機能は上位レベルで詳細テストしない
- **失敗時の特定容易性**: テストが失敗した際に原因を素早く特定できる粒度を保つ
